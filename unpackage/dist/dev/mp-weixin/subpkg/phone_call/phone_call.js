(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["subpkg/phone_call/phone_call"],{227:function(e,t,n){"use strict";(function(e,t){var a=n(4);n(26);a(n(25));var r=a(n(228));e.__webpack_require_UNI_MP_PLUGIN__=n,t(r.default)}).call(this,n(1)["default"],n(2)["createPage"])},228:function(e,t,n){"use strict";n.r(t);var a=n(229),r=n(231);for(var i in r)["default"].indexOf(i)<0&&function(e){n.d(t,e,(function(){return r[e]}))}(i);n(233);var o,s=n(36),l=Object(s["default"])(r["default"],a["render"],a["staticRenderFns"],!1,null,null,null,!1,a["components"],o);l.options.__file="subpkg/phone_call/phone_call.vue",t["default"]=l.exports},229:function(e,t,n){"use strict";n.r(t);var a=n(230);n.d(t,"render",(function(){return a["render"]})),n.d(t,"staticRenderFns",(function(){return a["staticRenderFns"]})),n.d(t,"recyclableRender",(function(){return a["recyclableRender"]})),n.d(t,"components",(function(){return a["components"]}))},230:function(e,t,n){"use strict";var a;n.r(t),n.d(t,"render",(function(){return r})),n.d(t,"staticRenderFns",(function(){return o})),n.d(t,"recyclableRender",(function(){return i})),n.d(t,"components",(function(){return a}));var r=function(){var e=this,t=e.$createElement;e._self._c},i=!1,o=[];r._withStripped=!0},231:function(e,t,n){"use strict";n.r(t);var a=n(232),r=n.n(a);for(var i in a)["default"].indexOf(i)<0&&function(e){n.d(t,e,(function(){return a[e]}))}(i);t["default"]=r.a},232:function(e,t,n){"use strict";(function(e,a){var r=n(4);Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=r(n(30)),o=r(n(11)),s=r(n(32)),l=r(n(33)),u=n(41);function c(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function d(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?c(Object(n),!0).forEach((function(t){(0,o.default)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):c(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var f=function(){n.e("components/scrollText").then(function(){return resolve(n(474))}.bind(null,n)).catch(n.oe)},h=l.default.urls.voiceUrl,p=getApp(),g={data:function(){return{imgUrl:p.globalData.baseImageUrl,inputStatus:!1,hasVoice:!1,aiSpeeking:!1,aiThrinking:!0,audioCtx:e.createWebAudioContext(),lowVoiceCount:0,highVoiceCount:0,currentPlayIndex:0,index:0,resultArrayBuffer:[],arrayBufferLength:0,result:[],longTimeNoInput:!1,action:"",welcomeVoice:[p.globalData.baseImageUrl+"/worker/call_wel01.mp3",p.globalData.baseImageUrl+"/worker/call_wel02.mp3"],receiveEnd:!1,currentTransIndex:0,closeStatus:!1,errorVoice:p.globalData.baseImageUrl+"/worker/error.mp3?time="+(new Date).getTime(),requestTask:null,receiveCount:0,transTimer:null,playTimer:null,isWelcome:!0,status:"",job_id:"",errorTimer:null,getResponeTime:0}},components:{scrollText:f},onLoad:function(e){var t=this;return(0,s.default)(i.default.mark((function n(){return i.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:a.hideShareMenu(),t.setInCall(),p.globalData.Audio.onPlay((function(e){t.aiSpeeking=!0,t.aiThrinking=!1,t.inputStatus=!1,t.hasVoice=!1})),p.globalData.Audio.onStop((function(e){})),p.globalData.Audio.onEnded((function(e){t.isWelcome=!1,t.startRecord()})),t.status=e.status?e.status:"",t.job_id=e.job_id?e.job_id:"",n.t0=t.status,n.next="interview"===n.t0?10:"findjob"===n.t0?14:"surejob"===n.t0?17:21;break;case 10:return t.action="audio_interview",t.isWelcome=!1,t.handleAutoAction(),n.abrupt("break",23);case 14:return t.action="audio_look_for_job",t.userEnter(),n.abrupt("break",23);case 17:return t.action="audio_want_application",t.isWelcome=!1,t.handleAutoAction(),n.abrupt("break",23);case 21:return t.userEnter(),n.abrupt("break",23);case 23:case"end":return n.stop()}}),n)})))()},onShow:function(){this.initRecord()},onHide:function(){p.globalData.Audio.pause(),p.globalData.Audio.offPlay(),p.globalData.Audio.offPause(),p.globalData.Audio.offStop(),p.globalData.Audio.offEnded(),p.globalData.manager.stop(),p.globalData.Audio.stop(),this.closeStatus||this.close()},watch:{lowVoiceCount:function(e){var t=this;t.highVoiceCount>2?e>10&&p.globalData.manager.stop():e>20&&p.globalData.manager.stop()},highVoiceCount:function(e){e>2?"interview"==this.status?this.action="audio_interview":"findjob"==this.status?this.action="audio_look_for_job":"surejob"==this.status?this.action="audio_want_application":this.action="":this.action="audio_call_user_long_time_without_talking"},inputStatus:function(e){e&&this.resetData()},resultArrayBuffer:function(e){this.arrayBufferLength=e.length},result:function(e){}},computed:d({},(0,u.mapState)(["answering","connected","connecting","canSend","inChannel","answerContinue","channelQaLen","channelId","channelQaList","location","token","callContent","incallEnroll","incallJobId","hangUpFirst"])),methods:d(d({},(0,u.mapMutations)(["setInCall","clearCallContent","setAiSpeekingEnd","resetAiSpeekingEnd","resetIncallEnroll","resetIncallJobId","resetHangUpFirst"])),{},{handleAutoAction:function(){var e=this.job_id?this.job_id:this.incallJobId;console.log("incallJobId：",e);var t=(new Date).getTime(),n=a.getStorageSync("openid")+t,r=n+"@@@"+this.channelId+"@@@"+e+"@@@"+this.action+"@@@",i=this.concatBuffer(r,"");this.sendMessage(i)},close:function(){this.closeStatus=!0,this.clearCallContent(),this.resetIncallEnroll(),this.resetIncallJobId(),this.audioCtx&&(this.audioCtx.close(),this.audioCtx=null),p.globalData.Audio&&p.globalData.Audio.stop(),p.globalData.manager&&p.globalData.manager.stop(),this.requestTask&&(this.requestTask.offChunkReceived(),this.requestTask.abort()),this.transTimer&&clearInterval(this.transTimer),this.playTimer&&clearInterval(this.playTimer);var e=getCurrentPages(),t=e[e.length-2];t&&t.$vm.changeTab&&t.$vm.changeTab(1),setTimeout((function(){a.navigateBack()}),500)},resetData:function(){this.currentPlayIndex=0,this.highVoiceCount=0,this.longTimeNoInput=!1,this.lowVoiceCount=0,this.result=[],this.receiveEnd=!1,this.resultArrayBuffer=[],this.arrayBufferLength=0,this.currentTransIndex=0,this.receiveCount=0},startRecord:function(){this.closeStatus||p.globalData.manager.start({format:"PCM",sampleRate:8e3,numberOfChannels:2,encodeBitRate:16e3,frameSize:4,duration:6e5})},initRecord:function(){var e=this;p.globalData.manager.onStart((function(t){e.playTipsVoice(),e.inputStatus=!0,e.aiSpeeking=!1,e.aiThrinking=!1,e.hasVoice=!0})),p.globalData.manager.onStop((function(t){var n=e;n.inputStatus=!1,n.hasVoice=!1,n.aiThrinking=!0,n.aiSpeeking=!1,n.closeStatus||e.handleRecorder(t)})),p.globalData.manager.onError((function(e){})),p.globalData.manager.onFrameRecorded((function(t){var n=e,a=t.frameBuffer,r=new Int16Array(a),i=r.length,o=0;if(r.forEach((function(e){o+=e*e})),!(o<1e4)){var s=o/i,l=parseInt(10*Math.log10(s));l<60?(n.hasVoice=!1,n.lowVoiceCount++):(n.hasVoice=!0,n.lowVoiceCount=0,n.highVoiceCount++)}}))},userEnter:function(){var e=Math.floor(Math.random()*this.welcomeVoice.length);p.globalData.Audio.src=this.welcomeVoice[e],p.globalData.Audio.play()},playError:function(){this.closeStatus||(p.globalData.Audio.src=this.errorVoice,p.globalData.Audio.play(),this.clearCallContent(),this.aiSpeeking=!0,this.aiThrinking=!1,this.inputStatus=!1,this.hasVoice=!1)},handleRecorder:function(t){var n=t.tempFilePath,r=(t.duration,this);e.getFileSystemManager().readFile({filePath:n,success:function(e){var t=r.job_id?r.job_id:r.incallJobId,n=(new Date).getTime(),i=a.getStorageSync("openid")+n,o=i+"@@@"+r.channelId+"@@@"+t+"@@@"+r.action+"@@@",s=r.concatBuffer(o,e.data);r.sendMessage(s)},fail:function(e){console.error("读取文件失败：",e),r.playError()}})},stringToUint8Array:function(e){for(var t=unescape(encodeURIComponent(e)),n=t.length,a=new Uint8Array(n),r=0;r<n;r++)a[r]=t.charCodeAt(r);return a},playTipsVoice:function(){var e=this.audioCtx.createOscillator(),t=this.audioCtx.createGain();e.connect(t),t.connect(this.audioCtx.destination),e.type="sine",e.frequency.value=300.5,t.gain.setValueAtTime(2,this.audioCtx.currentTime),t.gain.exponentialRampToValueAtTime(.001,this.audioCtx.currentTime+.5),e.start(),e.stop(this.audioCtx.currentTime+.5)},concatBuffer:function(e,t){var n=new Uint8Array(t),a=this.stringToUint8Array(e),r=a.length+n.length,i=new Uint8Array(r),o=0;return i.set(a,o),o+=a.length,i.set(n,o),i.buffer},sendMessage:function(t){console.log("用户发送了语音");var n=this;this.requestTask=e.request({url:h,enableChunked:!0,header:{"content-type":"application/json","app-id":l.default.urls.appid,"open-id":a.getStorageSync("openid")?a.getStorageSync("openid"):"",address:encodeURIComponent(JSON.stringify(n.location)),Authorization:"bearer "+a.getStorageSync("token"),"Content-Type":"application/octet-stream"},responseType:"arraybuffer",method:"POST",data:t,success:function(e){console.log("发送成功")},fail:function(e){console.error("request fail",e),n.requestTask.offChunkReceived(),p.globalData.Audio.stop(),setTimeout((function(){console.log("request请求失败或超时"),n.playError()}),500)}}),this.errorTimer=setInterval((function(){n.getResponeTime<15?n.receiveCount>0?(clearInterval(n.errorTimer),p.globalData.Audio.stop()):n.getResponeTime++:(n.getResponeTime=0,clearInterval(n.errorTimer))}),1e3),this.requestTask.onChunkReceived((function(e){n.receiveCount++,1==n.receiveCount&&(console.log("接收到第一条数据"),n.transFirst(e.data)),n.resultArrayBuffer.push(e.data);var t=new Uint8Array(e.data),a=new Uint8Array([91,68,79,78,69,93]),r=n.containsDoneMarker(t,a);r&&(console.log("检测到 [DONE] 标记"),n.receiveEnd=!0,n.requestTask.offChunkReceived())}))},transFirst:function(e){var t=this;t.audioCtx.decodeAudioData(e,(function(e){t.currentTransIndex++,1==t.currentTransIndex&&(t.resetAiSpeekingEnd(),t.playFirst(e),t.isWelcome=!1,t.playTipsVoice()),t.result.push(e),t.startTrans()}),(function(e){console.error("decodeAudioData fail",e),t.resultArrayBuffer.splice(0,1),t.startTrans()}))},startTrans:function(){var e=this;if(e.currentTransIndex<e.arrayBufferLength){var t=e.resultArrayBuffer[e.currentTransIndex];e.audioCtx.decodeAudioData(t,(function(t){e.currentTransIndex++,1==e.currentTransIndex&&(e.resetAiSpeekingEnd(),e.playFirst(t),e.isWelcome=!1,e.playTipsVoice()),e.result.push(t),e.startTrans()}),(function(t){console.error("decodeAudioData fail",t),e.resultArrayBuffer.splice(e.currentTransIndex,1),e.startTrans()}))}else e.receiveEnd||(e.transTimer=setInterval((function(){e.currentTransIndex<e.arrayBufferLength&&(e.startTrans(),clearInterval(e.transTimer))}),500))},containsDoneMarker:function(e,t){var n=t.length;if(e.length<n)return!1;for(var a=0;a<n;a++)if(e[e.length-n+a]!==t[a])return!1;return!0},playFirst:function(e){var t=this;t.aiSpeeking=!0,t.aiThrinking=!1,t.inputStatus=!1,t.hasVoice=!1;var n=this.audioCtx.createBufferSource();n.connect(this.audioCtx.destination),n.buffer=e,n.start(),n.onended=function(){t.currentPlayIndex++,t.play()}},play:function(){var e=this,t=this.result.length;if(e.currentPlayIndex!=t){e.aiSpeeking=!0,e.aiThrinking=!1,e.inputStatus=!1,e.hasVoice=!1;var n=this.audioCtx.createBufferSource();n.connect(this.audioCtx.destination),n.buffer=this.result[this.currentPlayIndex],n.start(),n.onended=function(){e.currentPlayIndex++,e.play()}}else t==e.arrayBufferLength&&e.receiveEnd?(e.resetData(),e.setAiSpeekingEnd(),e.clearCallContent(),console.log("语音对话中报名了吗：",e.incallEnroll),e.incallEnroll?(e.action="audio_interview",e.status="interview",e.aiSpeeking=!1,e.aiThrinking=!0,e.handleAutoAction()):e.hangUpFirst?(e.resetHangUpFirst(),e.close()):e.startRecord()):e.playTimer=setInterval((function(){e.currentPlayIndex<e.result.length&&(e.play(),clearInterval(e.playTimer))}),500)}})};t.default=g}).call(this,n(1)["default"],n(2)["default"])},233:function(e,t,n){"use strict";n.r(t);var a=n(234),r=n.n(a);for(var i in a)["default"].indexOf(i)<0&&function(e){n.d(t,e,(function(){return a[e]}))}(i);t["default"]=r.a},234:function(e,t,n){}},[[227,"common/runtime","common/vendor"]]]);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/subpkg/phone_call/phone_call.js.map