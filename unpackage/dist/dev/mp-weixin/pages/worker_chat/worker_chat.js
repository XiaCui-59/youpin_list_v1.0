(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/worker_chat/worker_chat"],{227:function(e,t,n){"use strict";(function(e,t){var o=n(4);n(26);o(n(25));var i=o(n(228));e.__webpack_require_UNI_MP_PLUGIN__=n,t(i.default)}).call(this,n(1)["default"],n(2)["createPage"])},228:function(e,t,n){"use strict";n.r(t);var o=n(229),i=n(231);for(var a in i)["default"].indexOf(a)<0&&function(e){n.d(t,e,(function(){return i[e]}))}(a);n(234);var s,r=n(36),c=Object(r["default"])(i["default"],o["render"],o["staticRenderFns"],!1,null,"0562240c",null,!1,o["components"],s);c.options.__file="pages/worker_chat/worker_chat.vue",t["default"]=c.exports},229:function(e,t,n){"use strict";n.r(t);var o=n(230);n.d(t,"render",(function(){return o["render"]})),n.d(t,"staticRenderFns",(function(){return o["staticRenderFns"]})),n.d(t,"recyclableRender",(function(){return o["recyclableRender"]})),n.d(t,"components",(function(){return o["components"]}))},230:function(e,t,n){"use strict";var o;n.r(t),n.d(t,"render",(function(){return i})),n.d(t,"staticRenderFns",(function(){return s})),n.d(t,"recyclableRender",(function(){return a})),n.d(t,"components",(function(){return o}));try{o={uNavbar:function(){return Promise.all([n.e("common/vendor"),n.e("uni_modules/uview-ui/components/u-navbar/u-navbar")]).then(n.bind(null,422))}}}catch(r){if(-1===r.message.indexOf("Cannot find module")||-1===r.message.indexOf(".vue"))throw r;console.error(r.message),console.error("1. 排查组件名称拼写是否正确"),console.error("2. 排查组件是否符合 easycom 规范，文档：https://uniapp.dcloud.net.cn/collocation/pages?id=easycom"),console.error("3. 若组件不符合 easycom 规范，需手动引入，并在 components 中注册该组件")}var i=function(){var e=this,t=e.$createElement;e._self._c},a=!1,s=[];i._withStripped=!0},231:function(e,t,n){"use strict";n.r(t);var o=n(232),i=n.n(o);for(var a in o)["default"].indexOf(a)<0&&function(e){n.d(t,e,(function(){return o[e]}))}(a);t["default"]=i.a},232:function(e,t,n){"use strict";(function(e,o){var i=n(4);Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var a=i(n(30)),s=i(n(32)),r=i(n(11)),c=i(n(194)),l=i(n(233)),u=i(n(33)),h=n(41);function d(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function f(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?d(Object(n),!0).forEach((function(t){(0,r.default)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):d(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var g=function(){Promise.all([n.e("common/vendor"),n.e("components/login")]).then(function(){return resolve(n(454))}.bind(null,n)).catch(n.oe)},p=function(){n.e("components/worker_tabbar").then(function(){return resolve(n(461))}.bind(null,n)).catch(n.oe)},m=function(){n.e("components/chat").then(function(){return resolve(n(475))}.bind(null,n)).catch(n.oe)},b=getApp(),w={data:function(){return{period:c.default.periodList,ifSingle:1154==b.globalData.scene,showLogin:!1,imgUrl:b.globalData.baseImageUrl,marginTop:b.globalData.marginTop,tabMargin:b.globalData.tabMargin,list:[],scrollHeight:0,currentPage:1,pagination:{},tabbarHeight:0,systemHeight:b.globalData.systemHeight,inputHeight:0,inputing:!1,cancelRecord:!1,showVoice:!1,voicePermisson:!1,showSend:!1,question:"",historyList:[],qaList:[],jobId:"",action:"",noMayAsk:!1,historyId:"",newUser:"",loadAllHistory:!1,statusBarHeight:b.globalData.statusBarHeight,abnormalClose:!1,abnormalErr:!1,header:null,timer:null,responseStr:"",responCount:0,prinTimer:null,currentQalength:0,curRespone:{content:"",origin:"ai",msg_type:"text",card:null},currentProjectDetail:{id:"",name:"",worker_salary_min:"",worker_salary_max:"",worker_salary_type:""},manager:b.globalData.manager,touchStartTime:"",touchEndTime:""}},components:{tabbar:p,login:g,chat:m},computed:f({},(0,h.mapState)(["answering","connected","connecting","canSend","inChannel","answerContinue","channelQaLen","channelId","channelQaList","location","token","inCall","responEnd","aiReady","ad_tracking_id","callBackCount","audioSwitch"])),onLoad:function(){var e=this;return(0,s.default)(a.default.mark((function t(){return a.default.wrap((function(t){while(1)switch(t.prev=t.next){case 0:e.isLogin()&&(e.creatConnect(),e.initRecord());case 1:case"end":return t.stop()}}),t)})))()},onReady:function(){var e=this;return(0,s.default)(a.default.mark((function t(){return a.default.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.next=2,l.default.getElementInfo(".input_btn_wrap");case 2:e.btnInfo=t.sent,e.btnInfo&&(e.botSafe=b.globalData.systemHeight-e.btnInfo.top,e.scrollHeight=e.btnInfo.top-e.statusBarHeight-44),console.log("scrollHeight：",e.scrollHeight);case 5:case"end":return t.stop()}}),t)})))()},onReachBottom:function(){},onShow:function(){var t=this;return(0,s.default)(a.default.mark((function n(){var o;return a.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:if(o=t,!t.ifSingle){n.next=5;break}return n.abrupt("return");case 5:if(!t.isLogin()){n.next=14;break}return t.historyId=0,n.next=9,t.getHistory();case 9:t.historyList=n.sent,t.$nextTick((function(){o.$refs.chatRef.toScroll()})),e.onKeyboardHeightChange(t.listenKeyBoard),n.next=15;break;case 14:t.showLogin=!0;case 15:case"end":return n.stop()}}),n)})))()},onHide:function(){b.globalData.Audio.stop(),b.globalData.Audio.offPlay(),b.globalData.Audio.offPause(),b.globalData.Audio.offStop(),b.globalData.Audio.offEnded(),e.offKeyboardHeightChange(this.listenKeyBoard)},onUnload:function(){},watch:{question:function(e){this.showSend=!!e}},methods:f(f({},(0,h.mapMutations)(["openAnswering","closeAnswering","setConnected","unConnected","setConnecting","unConnecting","openCansend","closeCansend","notChannel","isChannel","addChannelQaList","openAnswerContinue","closeAnswerContinue","updateChannelQaList","setChannelId","setLocation","setToken","clearChannelQaList","notInCall","setCallContent","setRespEnd","notRespEnd","setInterviewCard","setIncallEnroll","setIncallJobId","resetIncallEnroll","closeInterviewCard","setAiReady","resetAiReady","resetCity","setChannelInterviewCard","closeChannelInterviewCard","setJobName","resetJobName","setJobId","resetJobId","setHangUpFirst","setQunCode","setAdTrackingId","setCallBackCount","resetCallBackCount"])),{},{inputBindFocus:function(e){this.isLogin()?e.detail.height&&(this.inputHeight=e.detail.height):this.showLogin=!0},onInput:function(e){this.question=e.target.value},doSend:function(e,t){e.ctrlKey&&13===e.keyCode?this.question+="\n":void 0!==e&&(this.sendQuestion(),e.preventDefault())},sendQuestion:function(){if(this.question){this.inputHeight=0;var e={content:this.question,origin:"customer",msg_type:"text"};this.send(this.question,e,"")}},send:function(t,n,o){var i=this;this.aiReady?(console.log("answering：",this.answering,"answerContinue：",this.answerContinue),this.answering||this.answerContinue?this.$refs.myModal.showMyModal({title:"目前有正在回复的对话，请稍后重试",showCancel:!1,confirmText:"好的"}):this.canSend&&(0==this.historyList.length&&e.showLoading(),this.question="",this.notChannel(),this.notInCall(),b.globalData.socketTask.send({data:"voice"==o?t:JSON.stringify({content:t,job_channel_id:"",job_id:i.jobId,action_type:i.action}),success:function(o){i.jobId="",i.action="",i.noMayAsk=!1,i.closeInterviewCard(),i.closeChannelInterviewCard(),i.$set(i,"question",""),e.hideLoading(),"ping"!=t&&(i.cancelRecord||(i.openAnswering(),n.printStr="",i.$set(i.qaList,i.qaList.length,n),i.num++,i.hold="h"+i.num,i.closeCansend()))},fail:function(e){i.jobId=""}}))):e.showToast({title:"连接中，请稍后",icon:"error",duration:2e3})},getHistory:function(){var e=this;return console.log("获取历史记录"),new Promise((function(t){var n="/api/chat/histories?last_message_id="+e.historyId+"&job_channel_id=";e.$aiRequest(n,"","GET").then((function(n){if(0==n.code){0==n.data.length?e.newUser=!0:e.newUser=!1;var o=n.data.reverse(),i=n.data.length;i>0&&(e.historyId=n.data[0].id),o=e.handleList(o),t(o)}}))}))},getMoreHistory:function(){var t=this,n=this;if(this.loadAllHistory)e.showToast({title:"已加载全部",icon:"none",duration:2e3}),setTimeout((function(){n.$refs.chatRef.refreshRestore()}),500);else{if(!this.historyId){if(this.answerContinue||this.answering)return void this.$refs.chatRef.refreshRestore();this.qaList=[]}e.showLoading();var o="/api/chat/histories?last_message_id="+this.historyId+"&job_channel_id=";this.$aiRequest(o).then((function(n){if(0==n.code){var o=n.data.length;if(e.hideLoading(),t.$refs.chatRef.scrollToPre(),t.$refs.chatRef.refreshRestore(),o>0){var i=n.data.reverse(),a=t.handleList(i);t.historyList=a.concat(t.historyList),t.scrollStr="his"+n.data[o-1].id,t.historyId=n.data[0].id}else t.loadAllHistory=!0}else t.$refs.chatRef.refreshRestore()}))}},handleList:function(e){for(var t=e.length,n=0;n<t;n++)"voice"==e[n].msg_type&&(e[n].voice.anmitionPlay=!1,e[n].showTranlate=!1,e[n].showTranIcon=!1);return e},makePhoneCall:function(){this.$store.dispatch("makePhoneCall")},closeLogin:function(){this.showLogin=!1},cancelLogin:function(){this.closeLogin(),e.switchTab({url:"/pages/worker_index/worker_index"})},handleLogin:function(){var e=this;return(0,s.default)(a.default.mark((function t(){var n;return a.default.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return n=e,e.historyId=0,t.next=4,e.getHistory();case 4:e.historyList=t.sent,e.$nextTick((function(){n.$refs.chatRef.toScroll()})),e.creatConnect();case 7:case"end":return t.stop()}}),t)})))()},getTabbarHeight:function(e){this.tabbarHeight=e},creatConnect:function(){var t=this;return(0,s.default)(a.default.mark((function n(){var o;return a.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:if(t,t.header={"content-type":"application/json","app-id":u.default.urls.appid,"open-id":e.getStorageSync("openid")?e.getStorageSync("openid"):"",Authorization:"bearer "+e.getStorageSync("token")},t.abnormalClose=!1,t.abnormalErr=!1,e.showLoading({title:"正在链接客服"}),!b.globalData.socketTask){n.next=9;break}return n.next=8,t.close();case 8:return n.abrupt("return",!1);case 9:if(console.log("connected：",t.connected),!t.connected&&!t.connecting){n.next=12;break}return n.abrupt("return",!1);case 12:return t.setConnecting(),n.next=15,t.connectWebsocket(t.header);case 15:o=n.sent,"connectSocket:ok"==o.errMsg&&t.initWebsocket();case 17:case"end":return n.stop()}}),n)})))()},connectWebsocket:function(t){return new Promise((function(n){b.globalData.socketTask=e.connectSocket({url:b.globalData.wssUrl,header:t,method:"GET",success:function(e){n(e)},fail:function(t){console.log("err:",t),e.showModal({title:t.errMsg,showCancel:!1})}})}))},noInput:function(){var e=this;this.timer=setInterval((function(){var t="[PING]";e.send(t,"","")}),1e4)},resetData:function(){this.cancelRecord=!1,this.curRespone={content:"",origin:"ai",msg_type:"text",card:null},this.responCount=0,this.responseStr="",this.notRespEnd()},initWebsocket:function(){var t=this,n=this;b.globalData.socketTask.onOpen((function(o){t.abnormalClose=!1,t.abnormalErr=!1,t.unConnecting(),t.setConnected(),t.closeAnswering(),t.closeAnswerContinue(),t.openCansend(),t.setAiReady(),e.hideLoading(),n.currentProjectDetail.id&&!n.answerContinue&&(n.showProPop=!0),console.log("已成功建立链接onOpen",o)})),b.globalData.socketTask.onError((function(e){t.abnormalErr=!0,b.globalData.socketTask=null,clearInterval(n.timer),t.closeAnswering(),t.closeAnswerContinue(),t.unConnected(),t.unConnecting(),t.resetAiReady(),t.abnormalClose||setTimeout((function(){n.creatConnect()}),2e3)})),b.globalData.socketTask.onMessage((function(e){t.closeAnswering(),n.openAnswerContinue();var o=JSON.parse(e.data);if(console.log("websocket返回：",o),n.inCall)"audio_call_start_interview"==o.type?(n.setIncallJobId(o.job_id?o.job_id:""),n.setIncallEnroll()):n.resetIncallEnroll(),"applied"==o.type&&n.setHangUpFirst(),"[DONE]"!=o.message?n.setCallContent(o.message):(n.setRespEnd(),n.openCansend(),n.resetData(),n.closeAnswerContinue());else{if("QCODE"==o.type){var i={type:"QCODE"};n.curRespone.card=JSON.parse(JSON.stringify(i))}if("score_not_enough"==o.type){var a={type:"score_not_enough"};n.setJobName(o.job_name),n.curRespone.card=JSON.parse(JSON.stringify(a))}if("applied"==o.type){var s={type:"applied"};n.setJobName(o.job_name),n.setJobId(o.job_id),n.curRespone.card=JSON.parse(JSON.stringify(s))}"[DONE]"!=o.message?(n.responCount++,n.responseStr+=o.message,1==n.responCount&&(n.currentQalength=n.qaList.length,n.printResponse(),"QCODE"==o.type&&n.getQrcode(o.job_id))):(n.setRespEnd(),console.log("RespEnd：",n.responEnd),o.need_mayask&&n.getMayAsk())}})),b.globalData.socketTask.onClose((function(e){t.abnormalClose=!0,console.log("onClose",e),b.globalData.socketTask=null,t.unConnected(),t.unConnecting(),t.resetAiReady(),clearInterval(t.timer),t.abnormalErr||setTimeout((function(){n.creatConnect()}),2e3)}))},handleConnectErr:function(){var e=this.qaList.length;if(e>0&&"customer"==this.qaList[e-1].origin){this.closeAnswering(),this.openCansend(),this.closeAnswerContinue(),this.resetData(),clearInterval(this.prinTimer);var t={content:"抱歉！刚才打了个盹儿，没理解到您的意思，请重新发送一下您的问题。",printStr:"",msg_type:"text",origin:"ai",jobs:[],may_ask:[]};this.qaList.push(t)}},getQrcode:function(e){var t=this;if(e){var n="/worker/project/"+e+"/wework/external/group/qrcode";this.$request(n).then((function(e){0==e.code&&t.setQunCode(e.data.qrcode_url)}))}},sendBtnMsg:function(t){var n=this;return(0,s.default)(a.default.mark((function o(){var i,s;return a.default.wrap((function(o){while(1)switch(o.prev=o.next){case 0:if(console.log("sendBtnMsg被调用：",t),n,t.job_id&&(n.currentProjectDetail.id=t.job_id,n.currentProjectDetail.name=t.name),n.isLogin()){o.next=6;break}return n.showLogin=!0,o.abrupt("return");case 6:if(n.aiReady){o.next=9;break}return e.showToast({title:"连接中，请稍后",icon:"error",duration:2e3}),o.abrupt("return");case 9:if(!n.answerContinue){o.next=12;break}return e.showToast({title:"回答中，请稍后",icon:"error",duration:2e3}),o.abrupt("return");case 12:n.jobId=t.job_id,n.action=t.action,"job"==t.type?(i=[],i.push("请介绍一下"+t.msg),i.push("我对"+t.msg+"感兴趣，可以介绍一下吗？"),i.push(t.msg+"的工作内容是什么呢？福利待遇怎么样？"),i.push(t.msg+"这个工作看着还不错，请为我介绍下吧"),i.push(t.msg+"这个工作的详细信息可以说一下吗？"),s=Math.floor(Math.random()*i.length),n.question=i[s]):n.question=t.msg,n.sendQuestion();case 16:case"end":return o.stop()}}),o)})))()},close:function(){return new Promise((function(e){b.globalData.socketTask&&b.globalData.socketTask.close()}))},printResponse:function(){var e=this,t=0;console.log("开始打印"),this.prinTimer=setInterval((function(){var n=e.responseStr.length;t<n?(console.log("正在打印"),e.curRespone.content+=e.responseStr[t],e.inChannel?e.updateChannelQaList(e.curRespone):e.inCall||e.$set(e.qaList,e.currentQalength,e.curRespone),t++):(console.log("打印结束"),console.log(e.responEnd),e.responEnd&&(console.log("返回结束"),e.curRespone.card&&(e.curRespone.card.showCard=!0),clearInterval(e.prinTimer),e.openCansend(),e.resetData(),e.closeAnswerContinue()))}),30)},getMayAsk:function(){var e=this,t={job_channel_id:this.channelId},n=0,o={};console.log("执行了mayask"),this.$aiRequest("/api/chat/suggested-questions",t,"POST").then((function(t){e.channelId?(n=e.channelQaList.length-1,o=e.channelQaList[n],o.may_ask=t.questions,e.updateChannelQaList(o)):(n=e.qaList.length-1,o=e.qaList[n],o.may_ask=t.questions,e.$set(e.qaList,n,o))}))},listenKeyBoard:function(e){0==e.height?(this.inputHeight=0,this.scrollHeight=this.btnInfo.top-this.statusBarHeight-44):this.scrollHeight=b.globalData.systemHeight-this.statusBarHeight-44-e.height-this.btnInfo.height-10},initRecord:function(){var t=this;this.manager.onStart((function(e){t.inputing=!0})),this.manager.onStop((function(n){t.inputing=!1,t.touchEndTime-t.touchStartTime>1e3?t.handleRecorder(n):e.showToast({title:"长按时间过短",icon:"error"})})),this.manager.onError((function(e){t.inputing=!1}))},handleRecorder:function(t){var n=t.tempFilePath,i=t.duration;this.inputing=!1;var a=this;i<600?e.showToast({title:"说话时间过短",icon:"error",duration:2e3}):this.cancelRecord?this.cancelRecord=!1:o.getFileSystemManager().readFile({filePath:n,success:function(t){var o=t.data,s=new Uint8Array(o),r=(new Date).getTime(),c=e.getStorageSync("openid")+r,l=a.stringToUint8Array(c+"@@@@@@"+a.jobId+"@@@@@@"),u=l.length+s.length,h=new Uint8Array(u),d=0;h.set(l,d),d+=l.length,h.set(s,d);var f={id:c,content:"",origin:"customer",msg_type:"voice",voice:{media:{key:"",url:n},second:i/1e3,anmitionPlay:!1},showTranIcon:!1,showTranlate:!1,showTransing:!1};a.send(h.buffer,f,"voice")},fail:function(e){console.error("读取文件失败：",e)}})},stringToUint8Array:function(e){for(var t=unescape(encodeURIComponent(e)),n=t.length,o=new Uint8Array(n),i=0;i<n;i++)o[i]=t.charCodeAt(i);return o},startRecord:function(t){var n=this;this.isLogin()?this.aiReady?this.canSend?this.canSend&&(n.touchStartTime=t.timeStamp,n.$refs.chatRef.stopCurAudio(),e.vibrateShort({success:function(){}}),n.cancelRecord=!1,n.manager.start({duration:6e4,lang:"zh_CN"})):e.showToast({title:"正在回答请稍后",icon:"error",duration:2e3}):e.showToast({title:"连接中，请稍后",icon:"error",duration:2e3}):this.showLogin=!0},getSetting:function(){var t=this;e.getSetting({success:function(e){e.authSetting["scope.record"]?t.voicePermisson=!0:t.voicePermisson=!1},fail:function(e){}})},stopRecord:function(e){var t=this;this.inputing=!1,this.touchEndTime=e.timeStamp,this.touchEndTime-this.touchStartTime>1e3?this.manager.stop():setTimeout((function(){t.manager.stop()}),1e3)},cancelVoice:function(e){this.inputing=!1,this.manager.stop()},openSetting:function(){var t=this,n=e.getStorageSync("voiceAuth");n?e.openSetting({success:function(e){e.authSetting["scope.record"]&&(t.voicePermisson=!0,t.showVoice=!0)},fail:function(e){t.voicePermisson=!1}}):e.authorize({scope:"scope.record",success:function(e){t.voicePermisson=!0,t.showVoice=!0},fail:function(e){t.voicePermisson=!1},complete:function(){e.setStorageSync("voiceAuth",!0)}})},changeChatMethod:function(){this.showVoice?this.showVoice=!1:this.voicePermisson?this.showVoice=!0:this.openSetting()},handleTouchMove:function(e){if(this.canSend){var t=e.touches[e.touches.length-1].clientY<this.btnInfo.top;this.cancelRecord=!!t}},setScrollHeight:function(){this.scrollHeight=this.btnInfo.top-this.statusBarHeight-44}})};t.default=w}).call(this,n(2)["default"],n(1)["default"])},234:function(e,t,n){"use strict";n.r(t);var o=n(235),i=n.n(o);for(var a in o)["default"].indexOf(a)<0&&function(e){n.d(t,e,(function(){return o[e]}))}(a);t["default"]=i.a},235:function(e,t,n){}},[[227,"common/runtime","common/vendor"]]]);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/pages/worker_chat/worker_chat.js.map