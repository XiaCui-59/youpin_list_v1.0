(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["worker/worker_chat/worker_chat"],{"1cd1":function(e,t,n){"use strict";n.r(t);var o=n("ede4"),i=n.n(o);for(var s in o)["default"].indexOf(s)<0&&function(e){n.d(t,e,(function(){return o[e]}))}(s);t["default"]=i.a},"3b3e":function(e,t,n){"use strict";var o=n("dbf2"),i=n.n(o);i.a},dbf2:function(e,t,n){},e888:function(e,t,n){"use strict";(function(e,t){var o=n("47a9");n("2591");o(n("3240"));var i=o(n("fa7d"));e.__webpack_require_UNI_MP_PLUGIN__=n,t(i.default)}).call(this,n("3223")["default"],n("df3c")["createPage"])},ede4:function(e,t,n){"use strict";(function(e,o){var i=n("47a9");Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var s=i(n("7eb4")),a=i(n("ee10")),r=i(n("7ca3")),c=i(n("585c")),l=i(n("3070")),u=i(n("b30e")),h=n("8f59");function d(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function f(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?d(Object(n),!0).forEach((function(t){(0,r.default)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):d(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var g=getApp(),p={data:function(){return{period:c.default.periodList,ifSingle:1154==g.globalData.scene,showLogin:!1,imgUrl:g.globalData.baseImageUrl,marginTop:g.globalData.marginTop,tabMargin:g.globalData.tabMargin,list:[],scrollHeight:0,currentPage:1,pagination:{},tabbarHeight:0,systemHeight:g.globalData.systemHeight,inputHeight:0,inputing:!1,cancelRecord:!1,showVoice:!1,voicePermisson:!1,showSend:!1,question:"",historyList:[],qaList:[],jobId:"",action:"",noMayAsk:!1,historyId:"",newUser:"",loadAllHistory:!1,statusBarHeight:g.globalData.statusBarHeight,abnormalClose:!1,abnormalErr:!1,header:null,timer:null,responseStr:"",responCount:0,prinTimer:null,currentQalength:0,curRespone:{content:"",origin:"ai",msg_type:"text",card:null},currentProjectDetail:{id:"",name:"",worker_salary_min:"",worker_salary_max:"",worker_salary_type:""},manager:g.globalData.manager,touchStartTime:"",touchEndTime:"",responEnd:!1,showChat:!1,jobFromCast:{job_id:"",type:"",msg:"",action:""}}},components:{tabbar:function(){n.e("components/worker_tabbar").then(function(){return resolve(n("4993"))}.bind(null,n)).catch(n.oe)},login:function(){n.e("components/login").then(function(){return resolve(n("dadd"))}.bind(null,n)).catch(n.oe)},chat:function(){n.e("components/chat").then(function(){return resolve(n("b8f1"))}.bind(null,n)).catch(n.oe)}},computed:f({},(0,h.mapState)(["answering","connected","connecting","canSend","inChannel","answerContinue","channelQaLen","channelId","channelQaList","location","token","inCall","aiReady","ad_tracking_id","callBackCount","audioSwitch"])),onLoad:function(e){var t=this;return(0,a.default)(s.default.mark((function n(){return s.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:console.log("页面onload"),t.closeCansend(),t.unConnected(),t.unConnecting(),t.qaList=[],e.id&&(t.jobId=e.id),e.b_id&&(t.jobFromCast.job_id=e.b_id,t.jobFromCast.msg=e.b_msg,t.jobFromCast.type=e.b_type,t.jobFromCast.action=e.b_action),t.getSetting(),t.isLogin()&&(t.creatConnect(),t.initRecord());case 9:case"end":return n.stop()}}),n)})))()},onReady:function(){var e=this;return(0,a.default)(s.default.mark((function t(){return s.default.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.next=2,l.default.getElementInfo(".input_btn_wrap");case 2:e.btnInfo=t.sent,e.btnInfo&&(e.botSafe=g.globalData.systemHeight-e.btnInfo.top,e.scrollHeight=e.btnInfo.top-e.statusBarHeight-44),console.log("scrollHeight：",e.scrollHeight);case 5:case"end":return t.stop()}}),t)})))()},onReachBottom:function(){},onShow:function(){var t=this;return(0,a.default)(s.default.mark((function n(){var o;return s.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:if(o=t,t.curRespone={content:"",origin:"ai",msg_type:"text",card:null},t.showChat=!0,!t.ifSingle){n.next=7;break}return n.abrupt("return");case 7:if(!t.isLogin()){n.next=16;break}return t.historyId=0,n.next=11,t.getHistory();case 11:t.historyList=n.sent,t.$nextTick((function(){o.$refs.chatRef.toScroll()})),e.onKeyboardHeightChange(t.listenKeyBoard),n.next=17;break;case 16:t.showLogin=!0;case 17:case"end":return n.stop()}}),n)})))()},onHide:function(){g.globalData.Audio.stop(),g.globalData.Audio.offPlay(),g.globalData.Audio.offPause(),g.globalData.Audio.offStop(),g.globalData.Audio.offEnded(),e.offKeyboardHeightChange(this.listenKeyBoard)},onUnload:function(){this.showChat=!1,this.close(),e.hideLoading()},watch:{question:function(e){console.log("question newVal：",e),this.showSend=!!e},responseStr:function(e){console.log("responseStr newVal：",e)},qaList:{handler:function(e,t){console.log("worker_chat 监听qaList：",e)},deep:!0}},methods:f(f({},(0,h.mapMutations)(["openAnswering","closeAnswering","setConnected","unConnected","setConnecting","unConnecting","openCansend","closeCansend","notChannel","isChannel","addChannelQaList","openAnswerContinue","closeAnswerContinue","updateChannelQaList","setChannelId","setLocation","setToken","clearChannelQaList","notInCall","setCallContent","setInterviewCard","setIncallEnroll","setIncallJobId","resetIncallEnroll","closeInterviewCard","setAiReady","resetAiReady","resetCity","setChannelInterviewCard","closeChannelInterviewCard","setJobName","resetJobName","setJobId","resetJobId","setHangUpFirst","setQunCode","setAdTrackingId","setCallBackCount","resetCallBackCount"])),{},{closeBroadcast:function(){this.showBroadcast=!1,this.canPlay=!1},inputBindFocus:function(e){this.isLogin()?e.detail.height&&(this.inputHeight=e.detail.height):this.showLogin=!0},onInput:function(e){this.question=e.target.value},doSend:function(e,t){e.ctrlKey&&13===e.keyCode?this.question+="\n":void 0!==e&&(this.sendQuestion(),e.preventDefault())},sendQuestion:function(){if(this.question){this.inputHeight=0;var e={content:this.question,origin:"customer",msg_type:"text"};this.send(this.question,e,"")}},send:function(t,n,o){var i=this;this.aiReady?(console.log("answering：",this.answering,"answerContinue：",this.answerContinue),this.answering||this.answerContinue?this.$refs.myModal.showMyModal({title:"目前有正在回复的对话，请稍后重试",showCancel:!1,confirmText:"好的"}):this.canSend&&(0==this.historyList.length&&e.showLoading(),this.question="",this.notChannel(),this.notInCall(),g.globalData.socketTask.send({data:"voice"==o?t:JSON.stringify({content:t,job_channel_id:"",job_id:i.jobId,action_type:i.action}),success:function(o){i.jobId="",i.action="",i.$set(i.jobFromCast,"job_id",""),i.$set(i.jobFromCast,"action",""),i.$set(i.jobFromCast,"msg",""),i.$set(i.jobFromCast,"type",""),i.noMayAsk=!1,i.closeInterviewCard(),i.closeChannelInterviewCard(),i.$set(i,"question",""),e.hideLoading(),"ping"!=t&&(i.cancelRecord||(i.openAnswering(),n.printStr="",i.$set(i.qaList,i.qaList.length,n),i.num++,i.hold="h"+i.num,i.closeCansend()))},fail:function(e){i.jobId=""}}))):e.showToast({title:"连接中，请稍后",icon:"error",duration:2e3})},getHistory:function(){var e=this;return console.log("获取历史记录"),new Promise((function(t){var n="/api/chat/histories?last_message_id="+e.historyId+"&job_channel_id=";e.$aiRequest(n,"","GET").then((function(n){if(0==n.code){0==n.data.length?e.newUser=!0:e.newUser=!1;var o=n.data.reverse(),i=n.data.length;i>0&&(e.historyId=n.data[0].id),o=e.handleList(o),t(o)}}))}))},getWorkInfo:function(e){var t=this,n="/jobs/"+e;this.$request(n).then((function(n){if(0==n.code){var o={msg:n.data.name,type:"job",jobId:e,action:""};t.sendBtnMsg(o)}}))},getMoreHistory:function(){var t=this,n=this;if(this.loadAllHistory)e.showToast({title:"已加载全部",icon:"none",duration:2e3}),setTimeout((function(){n.$refs.chatRef.refreshRestore()}),500);else{if(!this.historyId){if(this.answerContinue||this.answering)return void this.$refs.chatRef.refreshRestore();this.qaList=[]}e.showLoading();var o="/api/chat/histories?last_message_id="+this.historyId+"&job_channel_id=";this.$aiRequest(o).then((function(n){if(0==n.code){var o=n.data.length;if(e.hideLoading(),t.$refs.chatRef.scrollToPre(),t.$refs.chatRef.refreshRestore(),o>0){var i=n.data.reverse(),s=t.handleList(i);t.historyList=s.concat(t.historyList),t.scrollStr="his"+n.data[o-1].id,t.historyId=n.data[0].id}else t.loadAllHistory=!0}else t.$refs.chatRef.refreshRestore()}))}},handleList:function(e){for(var t=e.length,n=0;n<t;n++)"voice"==e[n].msg_type&&(e[n].voice.anmitionPlay=!1,e[n].showTranlate=!1,e[n].showTranIcon=!1);return e},makePhoneCall:function(){this.$store.dispatch("makePhoneCall")},closeLogin:function(){this.showLogin=!1},cancelLogin:function(){this.closeLogin(),e.switchTab({url:"/pages/worker_index/worker_index"})},handleLogin:function(){var e=this;return(0,a.default)(s.default.mark((function t(){var n;return s.default.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return n=e,e.historyId=0,t.next=4,e.getHistory();case 4:e.historyList=t.sent,e.$nextTick((function(){n.$refs.chatRef.toScroll()})),e.creatConnect();case 7:case"end":return t.stop()}}),t)})))()},getTabbarHeight:function(e){this.tabbarHeight=e},creatConnect:function(){var t=this;return(0,a.default)(s.default.mark((function n(){var o;return s.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:if(t,t.header={"content-type":"application/json","app-id":u.default.urls.appid,"open-id":e.getStorageSync("openid")?e.getStorageSync("openid"):"",Authorization:"bearer "+e.getStorageSync("token")},t.abnormalClose=!1,t.abnormalErr=!1,!g.globalData.socketTask){n.next=8;break}return n.next=7,t.close();case 7:return n.abrupt("return",!1);case 8:if(console.log("connected：",t.connected),!t.connected&&!t.connecting){n.next=11;break}return n.abrupt("return",!1);case 11:return t.setConnecting(),n.next=14,t.connectWebsocket(t.header);case 14:o=n.sent,"connectSocket:ok"==o.errMsg&&t.initWebsocket();case 16:case"end":return n.stop()}}),n)})))()},connectWebsocket:function(t){return new Promise((function(n){g.globalData.socketTask=e.connectSocket({url:g.globalData.wssUrl,header:t,method:"GET",success:function(e){n(e)},fail:function(t){console.log("err:",t),e.showModal({title:t.errMsg,showCancel:!1})}})}))},noInput:function(){var e=this;this.timer=setInterval((function(){e.send("[PING]","","")}),1e4)},resetData:function(){this.cancelRecord=!1,this.curRespone={content:"",origin:"ai",msg_type:"text",card:null},this.responCount=0,this.responseStr="",this.responEnd=!1},initWebsocket:function(){var t=this,n=this;g.globalData.socketTask.onOpen((function(o){t.abnormalClose=!1,t.abnormalErr=!1,t.unConnecting(),t.setConnected(),t.closeAnswering(),t.closeAnswerContinue(),t.openCansend(),t.setAiReady(),e.hideLoading(),t.jobId&&t.getWorkInfo(t.jobId),t.jobFromCast.job_id&&t.sendBtnMsg(t.jobFromCast),n.currentProjectDetail.id&&!n.answerContinue&&(n.showProPop=!0),console.log("已成功建立链接onOpen",o)})),g.globalData.socketTask.onError((function(e){t.abnormalErr=!0,g.globalData.socketTask=null,clearInterval(n.timer),t.closeAnswering(),t.closeAnswerContinue(),t.unConnected(),t.unConnecting(),t.resetAiReady(),t.abnormalClose||setTimeout((function(){n.creatConnect()}),2e3)})),g.globalData.socketTask.onMessage((function(e){t.closeAnswering(),n.openAnswerContinue();var o=JSON.parse(e.data);if(console.log("websocket返回：",o),"QCODE"==o.type){n.curRespone.card=JSON.parse(JSON.stringify({type:"QCODE"}))}if("score_not_enough"==o.type){n.setJobName(o.job_name),n.curRespone.card=JSON.parse(JSON.stringify({type:"score_not_enough"}))}if("applied"==o.type){n.setJobName(o.job_name),n.setJobId(o.job_id),n.curRespone.card=JSON.parse(JSON.stringify({type:"applied"}))}"[DONE]"!=o.message?(n.responCount++,n.responseStr+=o.message,1==n.responCount&&(n.currentQalength=n.qaList.length,n.printResponse(),"QCODE"==o.type&&n.getQrcode(o.job_id))):(n.responEnd=!0,console.log("RespEnd：",n.responEnd),o.need_mayask&&n.getMayAsk())})),g.globalData.socketTask.onClose(function(){var e=(0,a.default)(s.default.mark((function e(o){return s.default.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return t.abnormalClose=!0,console.log("onClose",o),g.globalData.socketTask=null,t.unConnected(),t.unConnecting(),t.resetAiReady(),t.qaList=[],t.historyId=0,e.next=10,t.getHistory();case 10:t.historyList=e.sent,clearInterval(t.timer),t.abnormalErr||setTimeout((function(){n.creatConnect()}),2e3);case 13:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}())},handleConnectErr:function(){var e=this.qaList.length;if(e>0&&"customer"==this.qaList[e-1].origin){this.closeAnswering(),this.openCansend(),this.closeAnswerContinue(),this.resetData(),clearInterval(this.prinTimer);this.qaList.push({content:"抱歉！刚才打了个盹儿，没理解到您的意思，请重新发送一下您的问题。",printStr:"",msg_type:"text",origin:"ai",jobs:[],may_ask:[]})}},getQrcode:function(e){var t=this;if(e){var n="/worker/project/"+e+"/wework/external/group/qrcode";this.$request(n).then((function(e){0==e.code&&t.setQunCode(e.data.qrcode_url)}))}},sendBtnMsg:function(t){var n=this;return(0,a.default)(s.default.mark((function o(){var i,a;return s.default.wrap((function(o){while(1)switch(o.prev=o.next){case 0:if(console.log("sendBtnMsg被调用：",t),n,n.isLogin()){o.next=5;break}return n.showLogin=!0,o.abrupt("return");case 5:if(n.aiReady){o.next=8;break}return e.showToast({title:"连接中，请稍后",icon:"error",duration:2e3}),o.abrupt("return");case 8:if(!n.answerContinue){o.next=10;break}return o.abrupt("return");case 10:n.jobId=t.job_id,n.action=t.action,"job"==t.type?(i=[],i.push("请介绍一下"+t.msg),i.push("我对"+t.msg+"感兴趣，可以介绍一下吗？"),i.push(t.msg+"的工作内容是什么呢？福利待遇怎么样？"),i.push(t.msg+"这个工作看着还不错，请为我介绍下吧"),i.push(t.msg+"这个工作的详细信息可以说一下吗？"),a=Math.floor(Math.random()*i.length),n.question=i[a]):n.question=t.msg,n.sendQuestion();case 14:case"end":return o.stop()}}),o)})))()},close:function(){return new Promise((function(e){g.globalData.socketTask&&g.globalData.socketTask.close()}))},printResponse:function(){var e=this,t=0,n="";this.prinTimer=setInterval((function(){var o=e.responseStr.length;if(t<o){n+=e.responseStr[t],e.$set(e.curRespone,"content",n);var i=f({},e.curRespone);e.$set(e.qaList,e.currentQalength,i),t++}else e.responEnd&&(e.curRespone.card&&(e.curRespone.card.showCard=!0),clearInterval(e.prinTimer),console.log("打印完之后 qaList",e.qaList),e.openCansend(),e.resetData(),e.closeAnswerContinue(),e.jobId&&e.getWorkInfo(e.jobId),e.jobFromCast.job_id&&e.sendBtnMsg(e.jobFromCast))}),30)},getMayAsk:function(){var e=this,t={job_channel_id:this.channelId},n=0,o={};console.log("执行了mayask"),this.$aiRequest("/api/chat/suggested-questions",t,"POST").then((function(t){e.channelId?(n=e.channelQaList.length-1,o=e.channelQaList[n],o.may_ask=t.questions,e.updateChannelQaList(o)):(n=e.qaList.length-1,o=f({},e.qaList[n]),o.may_ask=t.questions,e.$set(e.qaList,n,o))}))},listenKeyBoard:function(e){0==e.height?(this.inputHeight=0,this.scrollHeight=this.btnInfo.top-this.statusBarHeight-44):this.scrollHeight=g.globalData.systemHeight-this.statusBarHeight-44-e.height-this.btnInfo.height-10},initRecord:function(){var t=this;this.manager.onStart((function(e){t.inputing=!0})),this.manager.onStop((function(n){t.inputing=!1,t.touchEndTime-t.touchStartTime>1e3?t.handleRecorder(n):e.showToast({title:"长按时间过短",icon:"error"})})),this.manager.onError((function(e){t.inputing=!1}))},handleRecorder:function(t){var n=t.tempFilePath,i=t.duration;this.inputing=!1;var s=this;i<600?e.showToast({title:"说话时间过短",icon:"error",duration:2e3}):this.cancelRecord?this.cancelRecord=!1:o.getFileSystemManager().readFile({filePath:n,success:function(t){var o=t.data,a=new Uint8Array(o),r=(new Date).getTime(),c=e.getStorageSync("openid")+r,l=s.stringToUint8Array(c+"@@@@@@"+s.jobId+"@@@@@@"),u=l.length+a.length,h=new Uint8Array(u),d=0;h.set(l,d),d+=l.length,h.set(a,d);var f={id:c,content:"",origin:"customer",msg_type:"voice",voice:{media:{key:"",url:n},second:i/1e3,anmitionPlay:!1},showTranIcon:!1,showTranlate:!1,showTransing:!1};s.send(h.buffer,f,"voice")},fail:function(e){console.error("读取文件失败：",e)}})},stringToUint8Array:function(e){for(var t=unescape(encodeURIComponent(e)),n=t.length,o=new Uint8Array(n),i=0;i<n;i++)o[i]=t.charCodeAt(i);return o},startRecord:function(t){this.aiReady?this.canSend?(this.touchStartTime=t.timeStamp,this.$refs.chatRef.stopCurAudio(),e.vibrateShort({success:function(){}}),this.cancelRecord=!1,this.manager.start({duration:6e4,lang:"zh_CN"})):e.showToast({title:"正在回答请稍后",icon:"error",duration:2e3}):e.showToast({title:"连接中，请稍后",icon:"error",duration:2e3})},getSetting:function(){var t=this;e.getSetting({success:function(e){e.authSetting["scope.record"]?t.voicePermisson=!0:t.voicePermisson=!1},fail:function(e){}})},stopRecord:function(e){var t=this;this.inputing=!1,this.touchEndTime=e.timeStamp,this.touchEndTime-this.touchStartTime>1e3?this.manager.stop():setTimeout((function(){t.manager.stop()}),1e3)},cancelVoice:function(e){this.inputing=!1,this.manager.stop()},openSetting:function(){var t=this,n=e.getStorageSync("voiceAuth");n?e.openSetting({success:function(e){e.authSetting["scope.record"]&&(t.voicePermisson=!0,t.showVoice=!0)},fail:function(e){t.voicePermisson=!1}}):e.authorize({scope:"scope.record",success:function(e){t.voicePermisson=!0,t.showVoice=!0},fail:function(e){t.voicePermisson=!1},complete:function(){e.setStorageSync("voiceAuth",!0)}})},changeChatMethod:function(){this.showVoice?this.showVoice=!1:this.voicePermisson?this.showVoice=!0:this.openSetting()},handleTouchMove:function(e){if(this.canSend){var t=e.touches[e.touches.length-1].clientY<this.btnInfo.top;this.cancelRecord=!!t}},setScrollHeight:function(){this.scrollHeight=this.btnInfo.top-this.statusBarHeight-44}})};t.default=p}).call(this,n("df3c")["default"],n("3223")["default"])},f436:function(e,t,n){"use strict";n.d(t,"b",(function(){return i})),n.d(t,"c",(function(){return s})),n.d(t,"a",(function(){return o}));var o={uNavbar:function(){return Promise.all([n.e("common/vendor"),n.e("uni_modules/uview-ui/components/u-navbar/u-navbar")]).then(n.bind(null,"8e7b"))}},i=function(){var e=this.$createElement;this._self._c},s=[]},fa7d:function(e,t,n){"use strict";n.r(t);var o=n("f436"),i=n("1cd1");for(var s in i)["default"].indexOf(s)<0&&function(e){n.d(t,e,(function(){return i[e]}))}(s);n("3b3e");var a=n("828b"),r=Object(a["a"])(i["default"],o["b"],o["c"],!1,null,"3c35a3e8",null,!1,o["a"],void 0);t["default"]=r.exports}},[["e888","common/runtime","common/vendor"]]]);